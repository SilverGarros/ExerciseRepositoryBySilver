## 模型输出解析与 Flask 接口实现

#### 介绍

为了充分挖掘新媒体平台上积累的用户文本数据中的命名实体信息并为其他应用提供服务，我们需要将该识别模型部署到线上环境。一般来说，在自然语言处理应用的开发中，我们会使用 Web 框架（如 Flask）部署模型，并为外部提供 API 接口以支持在线预测。在本任务中，你们将接手一个部分完成的 Flask 项目。该项目已经包括了命名实体识别（NER）模型的载入、运行以及接收 tokenize 后的数据的代码。你们的核心任务是将模型的整数向量输出转换为一个结构化的实体标注列表，并通过 Flask API 返回这个列表。此步骤不仅实现了自动化的实体识别，更使得新媒体平台可以实时、高效地获取文本中的实体信息，为后续的数据分析和运营决策提供有力支撑。

#### 准备

开始答题前，请确认 `/home/project` 目录下包含以下文件：

- task.py
- ner.pt

其中：

- `task.py`，是你后续答题过程中编写代码的地方。
- `ner.pt`，是本任务提供的 PyTorch 模型权重文件，你可以通过如下方式来使用：

```python
import torch

index2label = {0: 'O', 1: 'B-PER', 2: 'I-PER', 3: 'B-LOC', 4: 'I-LOC'}
model = torch.jit.load('ner.pt')
model.eval()
outputs = model(torch.tensor([[100, 1003, 1009, 106, 102], [2000, 1003, 1009, 1030, 1090]])).detach().numpy()
output_labels = []
for output in outputs:
    output_labels.append([index2label[o] for o in output])
print(outputs, output_labels)
# [[0 3 4 1 2] [0 3 4 0 0]]
# [['O', 'B-LOC', 'I-LOC', 'B-PER', 'I-PER'], ['O', 'B-LOC', 'I-LOC', 'O', 'O']]
```

#### 目标

请在 `task.py` 文件中根据以下要求编写代码。

**`process`** 函数

- 功能
  - 将本任务提供的请求数据使用提供的模型进行推理。
  - 将推理结果转换为结构化的实体标注列表。
  - 对于不合理的序列，如单字实体 `['O', 'B-LOC', 'O']` 和以 `I-` 起始的实体 `['O', 'I-LOC', 'I-LOC']`，将其作为非实体序列处理。

实体标注列表为一个嵌套字典列表，其中列表中每个元素及其说明见下表。

| 字段名 | 释义           | 数值类型 |
| ------ | -------------- | -------- |
| start  | 实体的起始位置 | 数值     |
| end    | 实体的结束位置 | 数值     |
| label  | 实体类型       | 字符串   |

基于以下代码补充 `#TODO` 处的函数代码，并运行代码块，确保能够实现以下目标：

- 正确地使用模型进行推理。
- 返回正确的结构化结果。

> 提示 1：点击代码块右上方的 `copy` 按钮，将代码完整复制到右侧环境中后开始编码。

```python
#task-start
from flask import Flask, jsonify, request
import torch

app = Flask(__name__)
model = torch.jit.load('ner.pt')
model.eval()
index2label = {0: 'O', 1: 'B-PER', 2: 'I-PER', 3: 'B-LOC', 4: 'I-LOC'}

def process(inputs):

    # TODO
    return results


@app.route('/ner', methods=['POST'])
def ner():

    data = request.get_json()
    inputs = data['inputs']
    outputs = process(inputs)
    return jsonify(outputs)


if __name__ == '__main__':
    app.run(debug=True)
#task-end
```

> 提示 2：当实现以上目标后，考生可以在终端通过执行下面的命令来启动 Flask 服务并自行测试对应功能。

```bash
python task.py
```

请求示例：

> 提示 3：新建一个终端窗口以执行以下命令。

```bash
curl 'http://127.0.0.1:5000/ner' \
--header 'Content-Type: application/json' \
--data '{"inputs": [[100, 1003, 1009, 106, 102, 1004, 1003], [2000, 1003, 1009, 1030, 1090, 1003, 2300]]}'
```

输出示例：

```json
[
  [
    {
      "end": 2,
      "label": "LOC",
      "start": 1
    },
    {
      "end": 4,
      "label": "PER",
      "start": 3
    }
  ],
  [
    {
      "end": 2,
      "label": "LOC",
      "start": 1
    }
  ]
]
```

#### 规定

- 切勿删除以上代码块中的任何字符，以免造成判题不通过。
- 切勿修改任务中默认提供的文件名称、函数名称等，以免造成判题不通过。

#### 判分标准

- 实现目标，该题得 10 分；
- 未实现目标，该题得 0 分。