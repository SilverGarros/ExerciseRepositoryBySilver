## 基于 PyTorch 模型的 ONNX 转换与推理实现

#### 介绍

在新媒体平台的实际应用中，我们可能需要将训练后的模型转换为其他格式，以支持不同的推理引擎。ONNX（Open Neural Network Exchange）提供了一个开放的源模型格式，支持多种深度学习框架之间的模型转换。在本任务中你们需要将给定的基于 PyTorch 的文本分类模型转换为 ONNX 格式，并实现一个使用 ONNX 模型进行推理的简单应用。

#### 准备

开始答题前，请确认 `/home/project` 目录下包含以下文件：

- task.py
- model.pt

其中：

- `task.py`，是你后续答题过程中编写代码的地方。
- `model.pt`，是本任务提供的 PyTorch 模型权重文件，你可以通过如下方式来使用：

```python
import torch
import torch.nn as nn

class TextClassifier(nn.Module):
    def __init__(self, vocab_size=1000, embed_dim=128, hidden_dim=512, num_classes=2):
        super(TextClassifier, self).__init__()

        self.embedding = nn.Embedding(vocab_size, embed_dim)
        self.rnn = nn.LSTM(embed_dim, hidden_dim)
        self.fc = nn.Linear(hidden_dim, num_classes)

    def forward(self, text):

        embedded = self.embedding(text)
        packed_output, (hidden, cell) = self.rnn(embedded)
        output = self.fc(hidden.squeeze(0))
        return output

model = TextClassifier()
model.load_state_dict(torch.load('model.pt'))
model.eval()
output = model(torch.ones([256, 1], dtype=torch.long))
print(output.detach().numpy().tolist())
# [[0.05428319424390793, 0.09556099772453308]]
```

#### 目标

请在 `task.py` 文件中根据以下要求编写代码。

**`convert` 函数**

- 功能
  - 将本任务提供的 pt 模型文件转换为 ONNX 格式。
  - ONNX 模型文件保存在 `task.py` 文件同级目录下。
  - ONNX 模型文件名为 `text_classifier.onnx`。

**`inference` 函数**

- 功能
  - 读取 ONNX 模型文件。
  - 使用 ONNX 模型进行推理。
  - 返回推理结果。
- 参数
  - model_path，字符串类型，ONNX 模型文件的绝对路径。
  - input，整数列表类型，为待预测样本，示例如：[101, 304, 993, 1008,102]。
- 返回值
  - result，浮点数列表类型，为 ONNX 文件推理结果，示例如：[[0.53419, 0.44313]]。

基于以下代码补充 `#TODO` 处的函数代码，并执行 `main()` 函数，确保能够实现以下目标：

- 正确转换模型文件。
- 正确输出推理结果。

> 提示：点击代码块右上方的 `copy` 按钮，将代码完整复制到右侧环境中后开始编码。

```python
#task-start
import numpy as np
import onnxruntime as ort
import torch
import torch.nn as nn


class TextClassifier(nn.Module):
    def __init__(self, vocab_size=1000, embed_dim=128, hidden_dim=512, num_classes=2):
        super(TextClassifier, self).__init__()

        self.embedding = nn.Embedding(vocab_size, embed_dim)
        self.rnn = nn.LSTM(embed_dim, hidden_dim)
        self.fc = nn.Linear(hidden_dim, num_classes)

    def forward(self, text):

        embedded = self.embedding(text)
        packed_output, (hidden, cell) = self.rnn(embedded)
        output = self.fc(hidden.squeeze(0))
        return output


def convert():
    # TODO


def inference(model_path, input):
    # TODO
    return result


def main():
    convert()
    result = inference('/home/project/text_classifier.onnx', [101, 304, 993, 108,102])
    print(result)


if __name__ == '__main__':
    main()
#task-end
```

#### 规定

- 切勿删除以上代码块中的任何字符，以免造成判题不通过。
- 切勿修改任务中默认提供的文件名称、函数名称等，以免造成判题不通过。

#### 判分标准

- 实现目标，该题得 10 分；
- 未实现目标，该题得 0 分。

> 总通过次数: 34  |  总提交次数: 44  |  通过率: 77.3%
>难度: 中等   标签: Python, 模型推理, Pytorch